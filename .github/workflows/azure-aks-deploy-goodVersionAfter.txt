name: Azure K8S deploy
on:
  workflow_run:
    workflows: ["Docker Image CI"]
    types:
      - completed
  push:
    branches: ["feature/yaterrrrra"]
    paths:
      - ".github/workflows/azure-aks-deploy.yml"
      - "manifests/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: |
          az acr login -n challengesemestre2
          az account set --subscription e354bc29-fa51-443a-be90-a1191487a664
          az aks get-credentials --resource-group FR_CHALLENGE_SEMESTRE2 --name challengeSemestreAKS
    # kubectl delete namespace challengespace
    # kubectl create namespace challengespace

      - uses: Azure/aks-set-context@v1
        with:
            creds: '${{ secrets.AZURE_CREDENTIALS }}'
            cluster-name: challengeSemestreAKS
            resource-group: FR_CHALLENGE_SEMESTRE2

      - uses: azure/k8s-deploy@v1.2
        with:
          namespace: "default"
          manifests: |
            manifests/deployment.yml
            manifests/service.yml
 #           manifests/ingress.yml
          images: |
            idboubacar/challenge-semestre2-gateway-api:latest