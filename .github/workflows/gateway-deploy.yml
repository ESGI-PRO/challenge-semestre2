name: gateway deployment
on:
  workflow_run:
    workflows: ["Docker Image CI"]
    types:
      - completed
  push:
    branches: ["feature/testdocker"]
    paths:
      - ".github/workflows/gateway-deploy.yml"
      - "gateway-api/**"
      - "manifests/gateway"
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - run: |
          az login
          az acr login -n challengeiw3
          az account set --subscription 3e16dd7c-61e5-4d26-946a-5e09d779e669
          az aks get-credentials --resource-group challenge_iw3 --name myAKSCluster
      
      - name: Build and push
        run: |
          docker build "./gateway-api" -f  "./gateway-api/Dockerfile" -t challengeiw3.azurecr.io/challenge-gateway:latest
          docker push challengeiw3.azurecr.io/challenge-gateway:latest
          az acr repository list --name challengeiw3 --output table
          az acr repository show-tags --name challengeiw3 --repository challenge-gateway --output table

      - name: Deploy to AKS
        env: 
          AZURECRNAME: challengeiw3
          AZURECRUSERNAME: challengeiw3
          AZURECRPASSWORD: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          az aks get-credentials --resource-group challenge_iw3 --name myAKSCluster
          kubectl get namespace | grep -q "^challengespace " || kubectl create namespace challengespace
          kubectl apply -f ./manifests/gateway/
          kubectl get pods -n challengespace
          kubectl get service -n challengespace
          kubectl get deployments -n challengespace        
  # kubectl create namespace challengespace
  # kubectl rollout restart deployment gateway -n ingress-nginx
